---
title: "Assignment 1"
author: "Srecko Curkovic"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---


In this assignment, we will create two line charts showing monthly total kBTU of residential and commercial electricity and gas consumption for the Bay Area from 2017 to the latest available month in 2020. One chart will show residential consumption and another will show commercial consumption.


We start with the initial knitting set-up. We want to show all code on the web report and we want to run it, but we do not want to show warnings and messages. We also want to show the final plots as outputs.


```{r setup}
knitr :: opts_chunk$set(include=T, echo=T, warning=F, message=F, eval=T)
```


We then load all the libraries necessary for this assignment.


```{r libraries}
library(tidyverse)
library(plotly)
library(sf)
library(tigris)
library(leaflet)
```


We want to do our analysis just for the Bay Area. So the first step is to get a list of the Bay Area ZIP codes. We create a list of the Bay counties and then use that to filter the list of all the ZIP codes in the country.


```{r code1}
bay_county_names <- c("Alameda", "Contra Costa", "Marin", "Napa", "San Francisco", 
                      "San Mateo", "Santa Clara", "Solano", "Sonoma")

bay_counties <- counties("CA", cb=T, progress_bar=F) %>% filter(NAME %in% bay_county_names)

usa_zips <- zctas(cb=T, progress_bar=F)

bay_zips <- usa_zips %>% st_centroid() %>% .[bay_counties, ] %>% 
  st_set_geometry(NULL) %>% left_join(usa_zips %>% select(GEOID10)) %>% st_as_sf()
```


Next step is to load the individual quarter data sets and merge them into two larger data sets: one for electricity and one for gas. We use nested for loops for this.


```{r code2}
type1 <- "Electric"
type2 <- "Gas"

pge_4yrs_elec <- NULL
pge_4yrs_gas <- NULL

for(year in c(2017, 2018, 2019, 2020)) {
  for(quarter in 1:4) {
    
    if(year==2020 && quarter==4) {
        break
    }
      
    filename1 <- paste0("PGE_", year, "_Q", quarter, "_", type1, "UsageByZip.csv")
    temp1 <- read_csv(filename1)
    pge_4yrs_elec <- rbind(pge_4yrs_elec, temp1)
    
    filename2 <- paste0("PGE_", year, "_Q", quarter, "_", type2, "UsageByZip.csv")
    temp2 <- read_csv(filename2)
    pge_4yrs_gas <- rbind(pge_4yrs_gas, temp2)
  }
}
```


Now we filter the two data sets to keep just the residential and commercial consumption, just the relevant columns, and just the data for the Bay Area. Here we make use of the list of the Bay Area ZIP codes.


```{r code3}
pge_4yrs_elec_filter <- filter(pge_4yrs_elec, CUSTOMERCLASS %in% 
                                 c("Elec- Residential", "Elec- Commercial"))

pge_4yrs_gas_filter <- filter(pge_4yrs_gas, CUSTOMERCLASS %in% 
                                 c("Gas- Residential", "Gas- Commercial"))

pge_4yrs_elec_select <- select(pge_4yrs_elec_filter, !c(COMBINED, AVERAGEKWH))
pge_4yrs_gas_select <- select(pge_4yrs_gas_filter, !c(COMBINED, AVERAGETHM))

pge_4yrs_elec_bay <- filter(pge_4yrs_elec_select, ZIPCODE %in% bay_zips$ZCTA5CE10)
pge_4yrs_gas_bay <- filter(pge_4yrs_gas_select, ZIPCODE %in% bay_zips$ZCTA5CE10)
```


Next we group and summarize the data for total kWh and total thm. We also sort the data in increasing order of year and month.


```{r code4}
pge_4yrs_elec_bay_group <- group_by(pge_4yrs_elec_bay, MONTH, YEAR, CUSTOMERCLASS)
pge_4yrs_gas_bay_group <- group_by(pge_4yrs_gas_bay, MONTH, YEAR, CUSTOMERCLASS)

pge_4yrs_elec_bay_sum <- summarize(pge_4yrs_elec_bay_group, TOTALKWH=sum(TOTALKWH, na.rm=T))
pge_4yrs_gas_bay_sum <- summarize(pge_4yrs_gas_bay_group, TOTALTHM=sum(TOTALTHM, na.rm=T))

pge_4yrs_elec_bay_sum_sort <- pge_4yrs_elec_bay_sum[
  order(pge_4yrs_elec_bay_sum$YEAR, pge_4yrs_elec_bay_sum$MONTH), ]

pge_4yrs_gas_bay_sum_sort <- pge_4yrs_gas_bay_sum[
  order(pge_4yrs_gas_bay_sum$YEAR, pge_4yrs_gas_bay_sum$MONTH), ]
```


We now merge the two data sets and we also convert both kWh and thm to kBtu using the following conversions:

1 kWh = 3.412 kBTU; 1 thm = 100.00000947817 kBTU


```{r code5}
pge_final <- pge_4yrs_elec_bay_sum_sort
pge_final$TOTALTHM <- pge_4yrs_gas_bay_sum_sort$TOTALTHM

pge_final$KBTU_ELEC <- pge_final$TOTALKWH * 3.412
pge_final$KBTU_GAS <- pge_final$TOTALTHM * 100.00000947817
```


In the next step, we split the previous data set into two new data sets: one for residential consumption and one for commercial consumption.


```{r code6}
pge_res <- filter(pge_final, CUSTOMERCLASS %in% c("Elec- Residential", "Gas- Residential"))
pge_comm <- filter(pge_final, CUSTOMERCLASS %in% c("Elec- Commercial", "Gas- Commercial"))

pge_res$CUSTOMERCLASS <- "Residential"
pge_comm$CUSTOMERCLASS <- "Commercial"
```


Now we finally have data sets that are ready for plotting. We create two separate line charts, one for each data set.


```{r code7, echo=T}
pge_chart_res <- 
  pge_res %>% 
  ggplot() + 
  geom_line(aes(x=1:45, y=KBTU_ELEC, color="darkred")) + 
  geom_line(aes(x=1:45, y=KBTU_GAS, color="darkblue")) + 
  labs(x="Month", y="kBTU", title="PG&E Monthly Residential Electricity & Gas Usage 
       in the Bay Area, 2017-2020") + 
  scale_colour_manual(name="Type", values=c("darkred"="darkred", "darkblue"="darkblue"), 
                      labels = c("Electricity", "Gas"))

pge_chart_comm <- 
  pge_comm %>% 
  ggplot() + 
  geom_line(aes(x=1:45, y=KBTU_ELEC, color="darkred")) +
  geom_line(aes(x=1:45, y=KBTU_GAS, color="darkblue")) + 
  labs(x="Month", y="kBTU", title="PG&E Monthly Commercial Electricity & Gas Usage 
       in the Bay Area, 2017-2020") + 
  scale_colour_manual(name="Type", values=c("darkred"="darkred","darkblue"="darkblue"), 
                      labels = c("Electricity", "Gas"))
```

```{r plot1}
pge_chart_res
```


!!! Comment on any observable changes in energy consumption that may be attributable to the COVID-19 pandemic.


```{r plot2}
pge_chart_comm
```


!!! Comment on any observable changes in energy consumption that may be attributable to the COVID-19 pandemic.


!!! Create at least one map that highlights which neighborhoods experienced the greatest change in electricity consumption before and after the pandemic began, and comment on your results. Explain any key assumptions you made in the analysis, or caveats about the data sources that you think the reader should be aware of.